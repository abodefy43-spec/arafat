<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق مشاركة الركاب</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Custom Design System -->
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #f59e42;
            --success: #22c55e;
            --error: #ef4444;
            --bg: #f8fafc;
            --text: #222;
            --font-main: 'Cairo', 'Arial', sans-serif;
        }
        body {
            font-family: var(--font-main);
            background: var(--bg);
            color: var(--text);
            direction: rtl;
            min-height: 100vh;
        }
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 2rem;
            text-align: center;
            letter-spacing: 0.5px;
        }
        .form-label {
            font-weight: 500;
            color: var(--primary);
        }
        .form-control {
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: box-shadow 0.2s;
        }
        .form-control:focus {
            box-shadow: 0 0 0 2px var(--primary);
            border-color: var(--primary);
        }
        #map {
            height: 350px;
            width: 100%;
            margin-top: 0.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
        .btn-primary {
            background: var(--primary);
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background 0.2s, transform 0.2s;
        }
        .btn-primary:hover, .btn-primary:focus {
            background: #1d4ed8;
            transform: translateY(-2px) scale(1.03);
        }
        .alert {
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            margin-top: 1rem;
            display: none;
            transition: opacity 0.3s;
        }
        .alert-success {
            background: var(--success);
            color: #fff;
        }
        .alert-danger {
            background: var(--error);
            color: #fff;
        }
        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            #map { height: 220px; }
        }
    </style>
    <style>
        body { font-family: 'Arial', sans-serif; direction: rtl; }
        #map { height: 400px; width: 100%; margin-top: 10px; }
        .form-group { margin-top: 20px; }
        .alert { display: none; }
        h1 { font-size: 2rem; font-weight: bold; margin-bottom: 30px; text-align:center; }
    </style>
</head>
<body>

<!-- Header -->
<header class="py-4 mb-3">
    <h1>تطبيق توصيل الطلاب</h1>
</header>

<main class="container" style="max-width: 500px;">
    <!-- Alerts -->
    <div id="success-alert" class="alert alert-success" role="alert" aria-live="polite"></div>
    <div id="error-alert" class="alert alert-danger" role="alert" aria-live="assertive"></div>

    <!-- Main Form -->
    <form id="user-form" novalidate autocomplete="off">
        <div class="mb-3">
            <label for="name" class="form-label">الاسم <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="name" name="name" required pattern="^[\u0600-\u06FFa-zA-Z\s]{2,}$" placeholder="أدخل اسمك" aria-required="true">
            <div class="invalid-feedback">يرجى إدخال الاسم بشكل صحيح (حروف فقط).</div>
        </div>
        <div class="mb-3">
            <label for="phone" class="form-label">رقم الهاتف <span class="text-danger">*</span></label>
            <input type="tel" class="form-control" id="phone" name="phone" required pattern="^05\d{8}$" placeholder="05XXXXXXXX" aria-required="true">
            <div class="invalid-feedback">يرجى إدخال رقم هاتف صحيح يبدأ بـ 05 ويتكون من 10 أرقام.</div>
        </div>
        <div class="mb-3">
            <label class="form-label">حدد موقعك على الخريطة <span class="text-danger">*</span></label>
            <div id="map" aria-label="خريطة الموقع"></div>
            <div id="coords" class="mt-2 text-secondary" style="font-size:0.95rem;"></div>
        </div>
        <button type="submit" class="btn btn-primary w-100">إرسال</button>
    </form>
</main>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Design System: Color, Typography, RTL, Transitions
    // --- Map Section ---
    const map = L.map('map').setView([21.2854, 39.2376], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    let userLocation = null;
    let coordsDiv = document.getElementById('coords');

    // Show marker and coordinates
    function setMarker(lat, lng) {
        if(userLocation) map.removeLayer(userLocation);
        userLocation = L.marker([lat, lng], {draggable: true}).addTo(map);
        coordsDiv.textContent = `الإحداثيات: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        userLocation.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            coordsDiv.textContent = `الإحداثيات: ${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}`;
        });
    }
    map.on('click', function(e){
        setMarker(e.latlng.lat, e.latlng.lng);
    });

    // Pre-fill form if user exists
    document.getElementById('name').addEventListener('blur', function() {
        const name = this.value.trim();
        if(!name) return;
        fetch('/get_user/' + encodeURIComponent(name))
            .then(res => res.json())
            .then(data => {
                if(data){
                    document.getElementById('phone').value = data.phone;
                    setMarker(data.latitude, data.longitude);
                    map.setView([data.latitude, data.longitude], 13);
                }
            });
    });

    // --- Form Validation & Submission ---
    const form = document.getElementById('user-form');
    const successAlert = document.getElementById('success-alert');
    const errorAlert = document.getElementById('error-alert');

    function showAlert(type, msg) {
        if(type === 'success') {
            successAlert.textContent = msg;
            successAlert.style.display = 'block';
            successAlert.style.opacity = 1;
            setTimeout(() => {
                successAlert.style.opacity = 0;
                setTimeout(() => successAlert.style.display = 'none', 300);
            }, 3000);
        } else {
            errorAlert.textContent = msg;
            errorAlert.style.display = 'block';
            errorAlert.style.opacity = 1;
            setTimeout(() => {
                errorAlert.style.opacity = 0;
                setTimeout(() => errorAlert.style.display = 'none', 300);
            }, 3500);
        }
    }

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        // HTML5 validation
        if(!form.checkValidity()) {
            form.classList.add('was-validated');
            showAlert('error', 'يرجى تعبئة جميع الحقول بشكل صحيح.');
            return;
        }
        // Map validation
        if(!userLocation) {
            showAlert('error', 'يرجى تحديد موقعك على الخريطة!');
            return;
        }
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const location = { lat: userLocation.getLatLng().lat, lng: userLocation.getLatLng().lng };

        fetch('/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, phone, location })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                // Navigate to thank you page if server requested redirect
                if(data.redirect) {
                    window.location.href = data.redirect;
                    return;
                }
                showAlert('success', 'تم إرسال بياناتك بنجاح!');
                form.reset();
                coordsDiv.textContent = '';
                if(userLocation) map.removeLayer(userLocation);
                form.classList.remove('was-validated');
            } else {
                showAlert('error', 'حدث خطأ في الإرسال');
            }
        })
        .catch(err => {
            showAlert('error', 'حدث خطأ في الإرسال');
        });
    });
</script>
</body>
</html>
